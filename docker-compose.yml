services:
  dbkeycloak:
    image: postgres:latest
    env_file:
      - .envars/.env.dbkeycloak
    ports:
      - ${DB_KEYCLOAK_PORT}:5432
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e \"GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n\" >&3;grep \"HTTP/1.1 200 OK\" <&3"]
      interval: 10s
      timeout: 5s
      retries: 5
  dbpercona:
    image: perconalab/postgres-tde-ext:latest
    env_file:
      - .envars/.env.dbpercona
    volumes:
      # NOTE : execution order is lexographical order
      # - ./dbpercona/pg-tde-create-ext.sh:/docker-entrypoint-initdb.d/pg-tde-create-ext.sh
      # - ./dbpercona/pg-tde-streaming-repl.sh:/docker-entrypoint-initdb.d/pg-tde-streaming-repl.sh
      - ./dbpercona/pg-xx-init.sql:/docker-entrypoint-initdb.d/pg-xx-init.sql
      - ./dbpercona/pg-xx-populate.sql:/docker-entrypoint-initdb.d/pg-xx-populate.sql
    ports:
      - ${DB_PERCONA_PORT}:5432
  keycloak:
    depends_on:
      - dbkeycloak
    image: quay.io/keycloak/keycloak:24.0.2
    env_file:
      - .envars/.env.keycloak
    volumes:
      - ./.keys:/opt/keycloak/conf
      - ./.keycloak_realms:/opt/keycloak/data/import
    ports:
      - 8080:8080
      - 8443:8443
    command: -v start-dev --import-realm
  backend:
    build: backend
    depends_on:
      - dbpercona
      - keycloak
    image: python:3.12
    env_file:
      - .envars/.env.backend
    volumes:
      - ./backend/app:/app
    ports:
      - ${APP_BACKEND_PORT}:80
